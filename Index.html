<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AP Training Log</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            font-family: system-ui, -apple-system, sans-serif;
        }
        .toggle-btn {
            transition: all 0.2s;
        }
        .toggle-btn.active {
            transform: scale(1.05);
        }
    </style>
</head>
<body class="min-h-screen bg-slate-900 text-slate-100">
    <div class="max-w-6xl mx-auto p-4 md:p-8">
        <div class="mb-8">
            <div class="flex items-center gap-3 mb-2">
                <svg class="w-10 h-10 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                </svg>
                <h1 class="text-4xl md:text-5xl font-bold text-cyan-400">AP Training Log</h1>
            </div>
            <p class="text-slate-400 text-lg ml-13">Subconscious Upward Movement Practice</p>
        </div>

        <div id="stats" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 mb-6" style="display: none;"></div>

        <div id="buttonContainer" class="flex flex-col sm:flex-row gap-3 mb-6">
            <button onclick="showAddForm()" class="flex-1 bg-cyan-600 hover:bg-cyan-700 text-white font-semibold py-3 px-6 rounded-lg flex items-center justify-center gap-2 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                New Entry
            </button>
            <button onclick="downloadData()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg flex items-center justify-center gap-2 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                </svg>
                Download
            </button>
            <label class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg flex items-center justify-center gap-2 transition-colors cursor-pointer">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                </svg>
                Upload
                <input type="file" accept=".json" onchange="uploadData(event)" class="hidden">
            </label>
        </div>

        <div id="formContainer" class="bg-slate-800 border border-slate-700 rounded-lg p-6 mb-6" style="display: none;">
            <h2 id="formTitle" class="text-2xl font-bold text-cyan-400 mb-6">New Entry</h2>
            
            <div class="space-y-6">
                <div class="bg-slate-750 p-4 rounded-lg">
                    <label class="block text-slate-300 font-semibold mb-3">Date</label>
                    <input type="date" id="date" class="w-full bg-slate-700 text-slate-100 border border-slate-600 rounded-lg px-4 py-3 text-lg">
                </div>

                <div class="bg-slate-750 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-purple-400 mb-4">Before Sleep</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-slate-300 mb-2">Focused on AP (How long?)</label>
                            <div class="flex gap-2">
                                <input type="number" id="focusedDuration" placeholder="1" min="0" class="flex-1 bg-slate-700 text-slate-100 border border-slate-600 rounded-lg px-4 py-3">
                                <select id="focusedDurationUnit" class="bg-slate-700 text-slate-100 border border-slate-600 rounded-lg px-4 py-3">
                                    <option value="mins">mins</option>
                                    <option value="hours" selected>hours</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-slate-300 mb-2">Practiced SUM?</label>
                            <div class="flex gap-2">
                                <input type="number" id="practicedSUM" placeholder="5" min="0" class="flex-1 bg-slate-700 text-slate-100 border border-slate-600 rounded-lg px-4 py-3">
                                <select id="practicedSUMUnit" class="bg-slate-700 text-slate-100 border border-slate-600 rounded-lg px-4 py-3">
                                    <option value="mins">mins</option>
                                    <option value="hours">hours</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-slate-300 mb-2">Intent Set Before Sleep?</label>
                            <div class="flex gap-3">
                                <button type="button" onclick="setToggle('intentSet', 'Yes')" id="intentSet-Yes" class="toggle-btn flex-1 bg-slate-700 hover:bg-slate-600 border-2 border-slate-600 text-white font-semibold py-3 px-6 rounded-lg transition-all">
                                    Yes
                                </button>
                                <button type="button" onclick="setToggle('intentSet', 'No')" id="intentSet-No" class="toggle-btn flex-1 bg-slate-700 hover:bg-slate-600 border-2 border-slate-600 text-white font-semibold py-3 px-6 rounded-lg transition-all">
                                    No
                                </button>
                            </div>
                        </div>

                        <div>
                            <label class="block text-slate-300 mb-2">Glass of Water?</label>
                            <div class="flex gap-3">
                                <button type="button" onclick="setToggle('glassOfWater', 'yes')" id="glassOfWater-yes" class="toggle-btn flex-1 bg-slate-700 hover:bg-slate-600 border-2 border-slate-600 text-white font-semibold py-3 px-6 rounded-lg transition-all">
                                    Yes
                                </button>
                                <button type="button" onclick="setToggle('glassOfWater', 'no')" id="glassOfWater-no" class="toggle-btn flex-1 bg-slate-700 hover:bg-slate-600 border-2 border-slate-600 text-white font-semibold py-3 px-6 rounded-lg transition-all">
                                    No
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-750 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-blue-400 mb-4">During Sleep</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-slate-300 mb-2"># of Awakenings Noticed</label>
                            <input type="number" id="awakenings" placeholder="0" min="0" class="w-full bg-slate-700 text-slate-100 border border-slate-600 rounded-lg px-4 py-3 text-lg">
                        </div>

                        <div>
                            <label class="block text-slate-300 mb-2">Moved on Awakening?</label>
                            <div class="flex gap-3">
                                <button type="button" onclick="setToggle('movedOnAwakening', 'yes')" id="movedOnAwakening-yes" class="toggle-btn flex-1 bg-slate-700 hover:bg-slate-600 border-2 border-slate-600 text-white font-semibold py-3 px-6 rounded-lg transition-all">
                                    Yes
                                </button>
                                <button type="button" onclick="setToggle('movedOnAwakening', 'no')" id="movedOnAwakening-no" class="toggle-btn flex-1 bg-slate-700 hover:bg-slate-600 border-2 border-slate-600 text-white font-semibold py-3 px-6 rounded-lg transition-all">
                                    No
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-750 p-4 rounded-lg">
                    <label class="block text-slate-300 font-semibold mb-3">Notes</label>
                    <textarea id="notes" placeholder="Any observations or experiences..." rows="4" class="w-full bg-slate-700 text-slate-100 border border-slate-600 rounded-lg px-4 py-3"></textarea>
                </div>

                <div class="flex gap-3 pt-2">
                    <button onclick="saveEntry()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg flex items-center justify-center gap-2 text-lg shadow-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        Save Entry
                    </button>
                    <button onclick="cancelForm()" class="flex-1 bg-slate-600 hover:bg-slate-700 text-white font-bold py-4 px-6 rounded-lg flex items-center justify-center gap-2 text-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <div class="bg-slate-800 border border-slate-700 rounded-lg overflow-x-auto">
            <table class="w-full text-sm">
                <thead class="bg-slate-700 text-slate-300">
                    <tr>
                        <th class="text-left p-3 font-semibold">Date</th>
                        <th class="text-left p-3 font-semibold">Intent?</th>
                        <th class="text-left p-3 font-semibold">SUM</th>
                        <th class="text-left p-3 font-semibold">Focus Time</th>
                        <th class="text-left p-3 font-semibold">Water</th>
                        <th class="text-left p-3 font-semibold">Wake-ups</th>
                        <th class="text-left p-3 font-semibold">Moved?</th>
                        <th class="text-left p-3 font-semibold">Notes</th>
                        <th class="text-right p-3 font-semibold">Actions</th>
                    </tr>
                </thead>
                <tbody id="entriesTable" class="divide-y divide-slate-700">
                </tbody>
            </table>
            <div id="emptyState" class="text-center text-slate-500 py-12">
                <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                </svg>
                <p class="text-lg">No entries yet. Start logging your practice!</p>
            </div>
        </div>
    </div>

    <script>
        let entries = [];
        let editingId = null;
        let formState = {
            intentSet: 'Yes',
            glassOfWater: 'yes',
            movedOnAwakening: 'yes'
        };

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            loadEntries();
            updateToggleButtons();
        });

        function setToggle(field, value) {
            formState[field] = value;
            updateToggleButtons();
        }

        function updateToggleButtons() {
            const fields = ['intentSet', 'glassOfWater', 'movedOnAwakening'];
            const options = ['Yes', 'No', 'yes', 'no'];
            
            fields.forEach(function(field) {
                const value = formState[field];
                options.forEach(function(option) {
                    const btn = document.getElementById(field + '-' + option);
                    if (btn) {
                        if (option === value) {
                            btn.classList.add('active', 'bg-cyan-600', 'border-cyan-500');
                            btn.classList.remove('bg-slate-700', 'border-slate-600');
                        } else {
                            btn.classList.remove('active', 'bg-cyan-600', 'border-cyan-500');
                            btn.classList.add('bg-slate-700', 'border-slate-600');
                        }
                    }
                });
            });
        }

        function loadEntries() {
            const stored = localStorage.getItem('apEntries');
            if (stored) {
                entries = JSON.parse(stored);
                entries.sort(function(a, b) {
                    return new Date(b.date) - new Date(a.date);
                });
            }
            renderEntries();
            renderStats();
        }

        function saveToStorage() {
            localStorage.setItem('apEntries', JSON.stringify(entries));
        }

        function showAddForm() {
            document.getElementById('formContainer').style.display = 'block';
            document.getElementById('buttonContainer').style.display = 'none';
            document.getElementById('formTitle').textContent = 'New Entry';
            editingId = null;
            resetForm();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function cancelForm() {
            document.getElementById('formContainer').style.display = 'none';
            document.getElementById('buttonContainer').style.display = 'flex';
            editingId = null;
            resetForm();
        }

        function resetForm() {
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            formState = {
                intentSet: 'Yes',
                glassOfWater: 'yes',
                movedOnAwakening: 'yes'
            };
            // FIX: Set default value to '1' and unit to 'hours' for focused duration
            document.getElementById('focusedDuration').value = '1';
            document.getElementById('focusedDurationUnit').value = 'hours';
            
            document.getElementById('practicedSUM').value = '';
            document.getElementById('practicedSUMUnit').value = 'mins';
            document.getElementById('awakenings').value = '';
            document.getElementById('notes').value = '';
            updateToggleButtons();
        }

        function saveEntry() {
            const entry = {
                id: editingId || 'entry_' + Date.now(),
                date: document.getElementById('date').value,
                focusedDuration: document.getElementById('focusedDuration').value,
                focusedDurationUnit: document.getElementById('focusedDurationUnit').value,
                practicedSUM: document.getElementById('practicedSUM').value,
                practicedSUMUnit: document.getElementById('practicedSUMUnit').value,
                intentSet: formState.intentSet,
                glassOfWater: formState.glassOfWater,
                awakenings: document.getElementById('awakenings').value,
                movedOnAwakening: formState.movedOnAwakening,
                notes: document.getElementById('notes').value
            };

            if (editingId) {
                const index = entries.findIndex(function(e) { return e.id === editingId; });
                entries[index] = entry;
            } else {
                entries.push(entry);
            }

            saveToStorage();
            loadEntries();
            cancelForm();
        }

        function editEntry(id) {
            const entry = entries.find(function(e) { return e.id === id; });
            if (!entry) return;

            editingId = id;
            document.getElementById('date').value = entry.date;
            document.getElementById('focusedDuration').value = entry.focusedDuration || '';
            document.getElementById('focusedDurationUnit').value = entry.focusedDurationUnit || 'mins';
            document.getElementById('practicedSUM').value = entry.practicedSUM || '';
            document.getElementById('practicedSUMUnit').value = entry.practicedSUMUnit || 'mins';
            formState.intentSet = entry.intentSet;
            formState.glassOfWater = entry.glassOfWater;
            document.getElementById('awakenings').value = entry.awakenings;
            formState.movedOnAwakening = entry.movedOnAwakening;
            document.getElementById('notes').value = entry.notes;

            updateToggleButtons();

            document.getElementById('formContainer').style.display = 'block';
            document.getElementById('buttonContainer').style.display = 'none';
            document.getElementById('formTitle').textContent = 'Edit Entry';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function deleteEntry(id) {
            if (!confirm('Delete this entry?')) return;
            entries = entries.filter(function(e) { return e.id !== id; });
            saveToStorage();
            loadEntries();
        }

        function renderEntries() {
            const tbody = document.getElementById('entriesTable');
            const emptyState = document.getElementById('emptyState');

            if (entries.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            var html = '';
            for (var i = 0; i < entries.length; i++) {
                var entry = entries[i];
                var dateParts = entry.date.split('-');
                var formattedDate = dateParts[1] + '/' + dateParts[2] + '/' + dateParts[0];
                
                var focusedDisplay = entry.focusedDuration ? entry.focusedDuration + ' ' + (entry.focusedDurationUnit || 'mins') : '-';
                var sumDisplay = entry.practicedSUM ? entry.practicedSUM + ' ' + (entry.practicedSUMUnit || 'mins') : '-';
                
                html += '<tr class="hover:bg-slate-750">';
                html += '<td class="p-3 text-cyan-400 font-medium whitespace-nowrap">' + formattedDate + '</td>';
                html += '<td class="p-3">' + entry.intentSet + '</td>';
                html += '<td class="p-3 text-purple-400">' + sumDisplay + '</td>';
                html += '<td class="p-3 text-blue-400">' + focusedDisplay + '</td>';
                html += '<td class="p-3">' + entry.glassOfWater + '</td>';
                html += '<td class="p-3 text-yellow-400">' + (entry.awakenings || '-') + '</td>';
                html += '<td class="p-3">' + entry.movedOnAwakening + '</td>';
                html += '<td class="p-3 text-slate-400 max-w-xs truncate">' + (entry.notes || '-') + '</td>';
                html += '<td class="p-3">';
                html += '<div class="flex gap-2 justify-end whitespace-nowrap">';
                html += '<button onclick="editEntry(\'' + entry.id + '\')" class="text-blue-400 hover:text-blue-300 p-1 hover:bg-slate-700 rounded" title="Edit entry">';
                html += '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">';
                html += '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>';
                html += '</svg>';
                html += '</button>';
                html += '<button onclick="deleteEntry(\'' + entry.id + '\')" class="text-red-400 hover:text-red-300 p-1 hover:bg-slate-700 rounded" title="Delete entry">';
                html += '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">';
                html += '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>';
                html += '</svg>';
                html += '</button>';
                html += '</div>';
                html += '</td>';
                html += '</tr>';
            }
            tbody.innerHTML = html;
        }

        function renderStats() {
            const statsDiv = document.getElementById('stats');
            if (entries.length === 0) {
                statsDiv.style.display = 'none';
                return;
            }

            statsDiv.style.display = 'grid';

            const intentSetYes = entries.filter(function(e) { return e.intentSet === 'Yes'; }).length;
            
            // Helper function to convert duration to minutes
            function durationToMins(value, unit) {
                const num = parseInt(value) || 0;
                if (unit === 'hours') {
                    return num * 60;
                }
                return num;
            }

            let sumTotal = 0;
            let sumCount = 0;
            entries.forEach(function(e) {
                if (e.practicedSUM) {
                    const mins = durationToMins(e.practicedSUM, e.practicedSUMUnit);
                    sumTotal += mins;
                    if (mins > 0) {
                        sumCount++;
                    }
                }
            });
            const avgSUM = sumCount > 0 ? sumTotal / sumCount : 0;
            
            let focusTotal = 0; // Total focused duration in minutes
            let focusCount = 0; // Number of entries with a focus duration
            entries.forEach(function(e) {
                if (e.focusedDuration) {
                    // FIX: Use durationToMins to convert hours/mins to total minutes
                    const mins = durationToMins(e.focusedDuration, e.focusedDurationUnit);
                    focusTotal += mins;
                    if (mins > 0) {
                        focusCount++;
                    }
                }
            });
            const avgFocused = focusCount > 0 ? focusTotal / focusCount : 0;
            
            let awakeningsTotal = 0;
            let awakeningsCount = 0;
            entries.forEach(function(e) {
                if (e.awakenings) {
                    awakeningsTotal += parseInt(e.awakenings || 0);
                    awakeningsCount++;
                }
            });
            const avgAwakenings = awakeningsCount > 0 ? awakeningsTotal / awakeningsCount : 0;
            
            const movedNo = entries.filter(function(e) { return e.movedOnAwakening === 'no'; }).length;

            statsDiv.innerHTML =
                '<div class="bg-slate-800 border border-slate-700 rounded-lg p-4">' +
                    '<div class="text-2xl font-bold text-cyan-400">' + entries.length + '</div>' +
                    '<div class="text-xs text-slate-400">Total Sessions</div>' +
                '</div>' +
                '<div class="bg-slate-800 border border-slate-700 rounded-lg p-4">' +
                    '<div class="text-2xl font-bold text-green-400">' + Math.round((intentSetYes / entries.length) * 100) + '%</div>' +
                    '<div class="text-xs text-slate-400">Intent Set</div>' +
                '</div>' +
                '<div class="bg-slate-800 border border-slate-700 rounded-lg p-4">' +
                    '<div class="text-2xl font-bold text-purple-400">' + avgSUM.toFixed(0) + 'm</div>' +
                    '<div class="text-xs text-slate-400">Avg SUM</div>' +
                '</div>' +
                '<div class="bg-slate-800 border border-slate-700 rounded-lg p-4">' +
                    // Display remains 'm' but calculation is correct
                    '<div class="text-2xl font-bold text-blue-400">' + avgFocused.toFixed(0) + 'm</div>' + 
                    '<div class="text-xs text-slate-400">Avg Focus</div>' +
                '</div>' +
                '<div class="bg-slate-800 border border-slate-700 rounded-lg p-4">' +
                    '<div class="text-2xl font-bold text-yellow-400">' + avgAwakenings.toFixed(1) + '</div>' +
                    '<div class="text-xs text-slate-400">Avg Wake-ups</div>' +
                '</div>' +
                '<div class="bg-slate-800 border border-slate-700 rounded-lg p-4">' +
                    '<div class="text-2xl font-bold text-orange-400">' + movedNo + '</div>' +
                    '<div class="text-xs text-slate-400">Still on Wake</div>' +
                '</div>';
        }

        function downloadData() {
            const dataStr = JSON.stringify(entries, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'ap-tracker-backup-' + new Date().toISOString().split('T')[0] + '.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        function uploadData(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const importedEntries = JSON.parse(event.target.result);
                    
                    if (!Array.isArray(importedEntries)) {
                        alert('Invalid file format');
                        return;
                    }

                    entries = importedEntries;
                    saveToStorage();
                    loadEntries();
                    alert('Successfully imported ' + importedEntries.length + ' entries!');
                } catch (error) {
                    console.error('Error importing data:', error);
                    alert('Failed to import data. Please check the file format.');
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        }
    </script>
</body>
</html>
